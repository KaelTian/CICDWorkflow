# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore
    - name: Test
      run: dotnet test --no-build --verbosity normal
  pack-docker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
  
      - name: æ„å»ºDockeré•œåƒ
        run: |
          docker build -t my-dotnet8-api:demo ./CICDDemo  # ç¡®ä¿ Dockerfile åœ¨ CICDDemo ç›®å½•ä¸‹
  
      - name: å¯åŠ¨å®¹å™¨å¹¶éªŒè¯æœåŠ¡
        run: |
          # å¯åŠ¨å®¹å™¨ï¼ˆæŒ‡å®šç›‘å¬åœ°å€ã€å‘½åå®¹å™¨æ–¹ä¾¿è°ƒè¯•ï¼‰
          docker run -d -p 80:80 -e ASPNETCORE_URLS=http://0.0.0.0:80 --name dotnet-demo-api my-dotnet8-api:demo
          
          # å¾ªç¯é‡è¯• 30 ç§’ï¼ˆæ¯ 3 ç§’ä¸€æ¬¡ï¼‰
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼Œå¼€å§‹é‡è¯•..."
          for i in {1..10}; do
            # å°è¯•è®¿é—®å¥åº·æ£€æŸ¥æ¥å£ï¼ˆæ ¹æ®å®é™…è·¯å¾„ä¿®æ”¹ï¼‰
            if curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health | grep -q "200"; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œå¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              docker logs dotnet-demo-api  # å¯é€‰ï¼šè¾“å‡ºæ—¥å¿—ç¡®è®¤
              exit 0
            fi
            echo "ğŸ”„ ç¬¬ $i æ¬¡é‡è¯•ï¼ˆå…± 10 æ¬¡ï¼‰ï¼Œç­‰å¾… 3 ç§’..."
            sleep 3
          done
          
          # å¤±è´¥æ—¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯
          echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
          echo "å®¹å™¨æ—¥å¿—ï¼š"
          docker logs dotnet-demo-api
          echo "å®¹å™¨çŠ¶æ€ï¼š"
          docker ps -a
          exit 1
  
      - name: æ¸…ç†èµ„æºï¼ˆå¯é€‰ï¼‰
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ¸…ç†
        run: |
          docker stop dotnet-demo-api || true
          docker rm dotnet-demo-api || true  
